<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Dashboard</title>
  <style>
    body {
      background-color: #0d0d0d;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color: #ffffff;
      margin: 0;
      padding: 20px;
      box-sizing: border-box;
    }

    .card {
      background-color: #1c1c1c;
      border-radius: 12px;
      box-shadow: 0 0 20px #9b59b6;
      padding: 30px 25px;
      max-width: 600px;
      margin: 40px auto;
    }

    .neon-text {
      color: #ffffff;
      font-size: 24px;
      text-shadow: 0 0 5px #9b59b6, 0 0 10px #9b59b6;
      margin-bottom: 20px;
      text-align: center;
    }

    .user-row {
      background: #2c2c2c;
      padding: 12px;
      margin: 8px 0;
      border-radius: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 15px;
    }

    .user-row button {
      width: auto;
      padding: 8px 12px;
      font-size: 14px;
      background-color: #e74c3c;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    .form-group input {
      width: 100%;
      padding: 12px;
      margin: 10px 0;
      background-color: #2c2c2c;
      border: 1px solid #9b59b6;
      border-radius: 8px;
      color: white;
      font-size: 16px;
      box-sizing: border-box;
    }

    .form-group button {
      width: 100%;
      padding: 12px;
      margin-top: 12px;
      background-color: #9b59b6;
      border: none;
      border-radius: 8px;
      color: white;
      font-weight: bold;
      font-size: 16px;
      cursor: pointer;
      box-shadow: 0 0 12px #9b59b6;
    }

    .logout-btn {
      margin-top: 30px;
      background-color: #34495e;
      width: 100%;
    }

    .logout-btn:hover {
      background-color: #2c3e50;
    }
  </style>
</head>
<body>
  <div class="card">
    <h2 class="neon-text">Dashboard Admin</h2>

    <div id="user-list"></div>

    <div class="form-group">
      <input type="text" id="new-username" placeholder="Username baru">
      <input type="password" id="new-password" placeholder="Password baru">
      <input type="date" id="new-expired" placeholder="Expired date">
      <button onclick="addUser()">Tambah User</button>
    </div>

    <button class="logout-btn" onclick="logout()">Logout</button>
  </div>

  <script>
    const JSON_BIN_URL = "https://api.jsonbin.io/v3/b/6892bfd5f7e7a370d1f4ea04";
    const JSON_BIN_KEY = "$2a$10$zKcSTNLMbWUQ.9p0ujh7CeLGdCj2TOAGYcOgvXmRwi5iyrV.HjPfu";
    let currentUsers = [];

    async function fetchUsers() {
      const res = await fetch(JSON_BIN_URL, {
        headers: { "X-Master-Key": JSON_BIN_KEY }
      });
      const data = await res.json();
      currentUsers = data.record;

      // Filter expired users
      const now = new Date();
      currentUsers = currentUsers.filter(u => !u.expired || new Date(u.expired) > now);

      renderUsers();
    }

    function renderUsers() {
      const list = document.getElementById("user-list");
      list.innerHTML = "";

      currentUsers.forEach((user, index) => {
        if (user.username === "admin") return;

        const row = document.createElement("div");
        row.className = "user-row";
        row.innerHTML = `
          <div>
            <strong>${user.username}</strong><br/>
            Expired: ${user.expired || "âˆž"}
          </div>
          <button onclick="deleteUser(${index})">Hapus</button>
        `;
        list.appendChild(row);
      });
    }

    async function deleteUser(index) {
      currentUsers.splice(index, 1);
      await updateBin();
    }

    async function addUser() {
      const u = document.getElementById("new-username").value;
      const p = document.getElementById("new-password").value;
      const e = document.getElementById("new-expired").value;
      if (!u || !p) return alert("Lengkapi username & password");
      currentUsers.push({ username: u, password: p, expired: e });
      await updateBin();
    }

    async function updateBin() {
      // Tambahkan kembali akun admin agar tidak hilang
      const admin = { username: "admin", password: "admin123" };
      const updated = [admin, ...currentUsers];
      await fetch(JSON_BIN_URL, {
        method: "PUT",
        headers: {
          "Content-Type": "application/json",
          "X-Master-Key": JSON_BIN_KEY
        },
        body: JSON.stringify(updated)
      });
      fetchUsers();
    }

    function logout() {
      localStorage.clear();
      window.location.href = "index.html";
    }

    if (!localStorage.getItem("adminLogged")) {
      window.location.href = "index.html";
    }

    fetchUsers();
    setInterval(fetchUsers, 30000); // auto-refresh 30 detik
  </script>
</body>
</html>